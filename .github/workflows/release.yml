name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger quando uma tag de vers√£o √© criada (ex: v1.0.0, v1.2.3)

jobs:
  build-windows:
    runs-on: windows-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Clone completo para acessar tags anotadas
      
      - name: Fetch tags
        run: git fetch --force --tags
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.2'  # Ajuste conforme necess√°rio
          channel: 'stable'
      
      - name: Verificar vers√£o do Flutter
        run: flutter --version
      
      - name: Instalar depend√™ncias
        run: flutter pub get
      
      - name: Habilitar build Windows
        run: flutter config --enable-windows-desktop
      
      - name: Build Windows Release
        run: flutter build windows --release
      
      - name: Extrair vers√£o do pubspec.yaml
        id: get_version
        shell: pwsh
        run: |
          $content = Get-Content pubspec.yaml -Raw
          $version = ($content | Select-String -Pattern 'version:\s*(\d+\.\d+\.\d+)').Matches.Groups[1].Value
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "Vers√£o extra√≠da: $version"
      
      - name: Download Inno Setup
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://jrsoftware.org/download.php/is.exe" -OutFile "innosetup-installer.exe"
          Start-Process -FilePath "innosetup-installer.exe" -ArgumentList "/VERYSILENT /SUPPRESSMSGBOXES /NORESTART /SP-" -Wait
      
      - name: Compilar instalador com Inno Setup
        shell: pwsh
        run: |
          # Atualiza a vers√£o no script Inno Setup
          $setupScript = Get-Content installer/setup.iss -Raw
          $setupScript = $setupScript -replace '#define MyAppVersion ".*"', "#define MyAppVersion `"${{ steps.get_version.outputs.VERSION }}`""
          Set-Content -Path installer/setup.iss -Value $setupScript
          
          # Compila o instalador
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer/setup.iss
      
      - name: Verificar arquivo gerado
        shell: pwsh
        run: |
          Get-ChildItem -Path output -Recurse
      
      - name: Extrair notas de release da tag
        id: get_release_notes
        shell: pwsh
        run: |
          # Extrai o conte√∫do completo da tag anotada usando git cat-file
          $tagName = "${{ github.ref_name }}"
          $tagContent = git cat-file -p $tagName
          
          # Debug: mostra o conte√∫do completo
          Write-Host "=== Conteudo completo da tag (cat-file) ==="
          Write-Host $tagContent
          Write-Host "==========================================="
          
          # Busca pela palavra "Release" e extrai tudo a partir dela
          if ($tagContent -match '(Release[\s\S]*)$') {
            $tagMessage = $matches[1].Trim()
            Write-Host "=== Mensagem da tag extraida ==="
            Write-Host $tagMessage
            Write-Host "================================"
            
            # Procura pela se√ß√£o "### Novidades"
            if ($tagMessage -match '###\s*Novidades\s*\r?\n\r?\n([\s\S]+)') {
              $notes = $matches[1].Trim()
              Write-Host "Notas extraidas da secao Novidades:"
              Write-Host $notes
              echo "NOTES=$notes" >> $env:GITHUB_OUTPUT
            } elseif ($tagMessage -match 'Release\s+[\d\.]+\s*\r?\n\r?\n([\s\S]+)') {
              # Fallback: usa tudo depois da primeira linha "Release X.Y.Z"
              $notes = $matches[1].Trim()
              Write-Host "Notas extraidas do corpo da tag (fallback):"
              Write-Host $notes
              echo "NOTES=$notes" >> $env:GITHUB_OUTPUT
            } else {
              # Se n√£o encontrar nada, usa a mensagem inteira exceto primeira linha
              $lines = $tagMessage -split '\r?\n'
              if ($lines.Length -gt 1) {
                $notes = ($lines[1..($lines.Length-1)] -join "`n").Trim()
                if ($notes) {
                  Write-Host "Notas extraidas do corpo completo (fallback 2):"
                  Write-Host $notes
                  echo "NOTES=$notes" >> $env:GITHUB_OUTPUT
                } else {
                  Write-Host "Nenhuma nota encontrada na tag"
                  echo "NOTES=Nenhuma nota de release fornecida." >> $env:GITHUB_OUTPUT
                }
              } else {
                Write-Host "Tag sem corpo/mensagem"
                echo "NOTES=Nenhuma nota de release fornecida." >> $env:GITHUB_OUTPUT
              }
            }
          } else {
            Write-Host "Palavra 'Release' nao encontrada na tag"
            echo "NOTES=Nenhuma nota de release fornecida." >> $env:GITHUB_OUTPUT
          }
      
      - name: Criar GitHub Release e Upload
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.get_version.outputs.VERSION }}
          body: |
            ## Workshop Shelf Helper v${{ steps.get_version.outputs.VERSION }}
            
            ### ‚ú® Novidades
            
            ${{ steps.get_release_notes.outputs.NOTES }}
            
            ---
            
            ### üì¶ Como Instalar
            
            1. **Baixe o instalador** abaixo (`WorkshopShelfHelper-Setup-${{ steps.get_version.outputs.VERSION }}.exe`)
            2. **Execute o arquivo** (ser√° solicitado privil√©gios de administrador)
            3. **Siga o assistente** de instala√ß√£o
            4. **Escolha o diret√≥rio** de instala√ß√£o (padr√£o: `C:\Program Files\Workshop Shelf Helper`)
            
            ### üîÑ Atualizando de Vers√£o Anterior
            
            Se voc√™ j√° tem uma vers√£o instalada:
            - ‚úÖ O instalador **detectar√° automaticamente** a vers√£o anterior
            - ‚úÖ Seu **banco de dados ser√° preservado** (sem perda de dados)
            - ‚úÖ A atualiza√ß√£o ser√° feita **automaticamente**
            - ‚úÖ Todas as suas **configura√ß√µes e componentes** permanecer√£o intactos
            
            ### üìã Requisitos
            
            - Windows 10 ou superior (64-bit)
            - Privil√©gios de administrador para instala√ß√£o
            - ~100 MB de espa√ßo em disco
            
            ### üÜò Suporte
            
            Em caso de problemas, consulte a documenta√ß√£o no reposit√≥rio ou abra uma issue.
          files: ./output/WorkshopShelfHelper-Setup-${{ steps.get_version.outputs.VERSION }}.exe
          draft: false
          prerelease: false
      
      - name: Upload build artifacts (backup)
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: output/*.exe
          retention-days: 90

