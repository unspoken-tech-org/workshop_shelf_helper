name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'  # Trigger quando uma tag de vers√£o √© criada (ex: v1.0.0, v1.2.3)

jobs:
  build-windows:
    runs-on: windows-latest
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.27.2'  # Ajuste conforme necess√°rio
          channel: 'stable'
      
      - name: Verificar vers√£o do Flutter
        run: flutter --version
      
      - name: Instalar depend√™ncias
        run: flutter pub get
      
      - name: Habilitar build Windows
        run: flutter config --enable-windows-desktop
      
      - name: Build Windows Release
        run: flutter build windows --release
      
      - name: Extrair vers√£o do pubspec.yaml
        id: get_version
        shell: pwsh
        run: |
          $content = Get-Content pubspec.yaml -Raw
          $version = ($content | Select-String -Pattern 'version:\s*(\d+\.\d+\.\d+)').Matches.Groups[1].Value
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "Vers√£o extra√≠da: $version"
      
      - name: Download Inno Setup
        shell: pwsh
        run: |
          Invoke-WebRequest -Uri "https://jrsoftware.org/download.php/is.exe" -OutFile "innosetup-installer.exe"
          Start-Process -FilePath "innosetup-installer.exe" -ArgumentList "/VERYSILENT /SUPPRESSMSGBOXES /NORESTART /SP-" -Wait
      
      - name: Compilar instalador com Inno Setup
        shell: pwsh
        run: |
          # Atualiza a vers√£o no script Inno Setup
          $setupScript = Get-Content installer/setup.iss -Raw
          $setupScript = $setupScript -replace '#define MyAppVersion ".*"', "#define MyAppVersion `"${{ steps.get_version.outputs.VERSION }}`""
          Set-Content -Path installer/setup.iss -Value $setupScript
          
          # Compila o instalador
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer/setup.iss
      
      - name: Verificar arquivo gerado
        shell: pwsh
        run: |
          Get-ChildItem -Path output -Recurse
      
      - name: Extrair notas de release da tag
        id: get_release_notes
        shell: pwsh
        run: |
          # Extrai a mensagem completa da tag
          $tagName = "${{ github.ref_name }}"
          $tagMessage = git tag -l --format='%(contents)' $tagName
          
          # Procura pela se√ß√£o "### Novidades"
          if ($tagMessage -match '### Novidades\s+([\s\S]*)') {
            $notes = $matches[1].Trim()
            # Escapa caracteres especiais para o GITHUB_OUTPUT
            $notes = $notes -replace '%', '%25'
            $notes = $notes -replace '\r', '%0D'
            $notes = $notes -replace '\n', '%0A'
            echo "NOTES=$notes" >> $env:GITHUB_OUTPUT
            echo "HAS_NOTES=true" >> $env:GITHUB_OUTPUT
          } else {
            echo "NOTES=Nenhuma nota de release fornecida." >> $env:GITHUB_OUTPUT
            echo "HAS_NOTES=false" >> $env:GITHUB_OUTPUT
          }
      
      - name: Criar GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: Release ${{ steps.get_version.outputs.VERSION }}
          body: |
            ## Workshop Shelf Helper v${{ steps.get_version.outputs.VERSION }}
            
            ### ‚ú® Novidades
            
            ${{ steps.get_release_notes.outputs.NOTES }}
            
            ---
            
            ### üì¶ Como Instalar
            
            1. **Baixe o instalador** abaixo (`WorkshopShelfHelper-Setup-${{ steps.get_version.outputs.VERSION }}.exe`)
            2. **Execute o arquivo** (ser√° solicitado privil√©gios de administrador)
            3. **Siga o assistente** de instala√ß√£o
            4. **Escolha o diret√≥rio** de instala√ß√£o (padr√£o: `C:\Program Files\Workshop Shelf Helper`)
            
            ### üîÑ Atualizando de Vers√£o Anterior
            
            Se voc√™ j√° tem uma vers√£o instalada:
            - ‚úÖ O instalador **detectar√° automaticamente** a vers√£o anterior
            - ‚úÖ Seu **banco de dados ser√° preservado** (sem perda de dados)
            - ‚úÖ A atualiza√ß√£o ser√° feita **automaticamente**
            - ‚úÖ Todas as suas **configura√ß√µes e componentes** permanecer√£o intactos
            
            ### üìã Requisitos
            
            - Windows 10 ou superior (64-bit)
            - Privil√©gios de administrador para instala√ß√£o
            - ~100 MB de espa√ßo em disco
            
            ### üÜò Suporte
            
            Em caso de problemas, consulte a documenta√ß√£o no reposit√≥rio ou abra uma issue.
          draft: false
          prerelease: false
      
      - name: Upload instalador para Release
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./output/WorkshopShelfHelper-Setup-${{ steps.get_version.outputs.VERSION }}.exe
          asset_name: WorkshopShelfHelper-Setup-${{ steps.get_version.outputs.VERSION }}.exe
          asset_content_type: application/octet-stream
      
      - name: Upload build artifacts (backup)
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: output/*.exe
          retention-days: 90

